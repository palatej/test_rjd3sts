library(rjd3sts)

data<-c(34.8,21,32.2,22.4,18.2,15.9,13.3,16.7,19,91.5,246.5,258.3,126.5,19.7,24.8,16.7,12.2,14.3,10.9,14.9,17.6,211.7,358.3,201,
        4,34.6,31.3,17,16.1,16.8,9.6,18.1,18.5,215.4,329.6,244.3,21.4,16.9,37.5,16.8,14.4,30,12,14.3,17.4,242.3,323.4,257.3,16,
        13.6,18.9,28.8,20.4,43.1,7.8,17.2,23.3,240.2,371.5,272.5,24.5,22.1,25.6,29.8,47.3,16.4,10,17.8,24.3,322.1,380,318.9,31,
        30.8,31.5,42.3,22.6,18.2,9.3,21,27.3,305.6,352.2,251.2,17.2,17.9,34.4,31.7,28.7,21.2,9,16.1,57.5,351.1,379.1,358.5,108.2,
        20,34.2,28.2,27.1,17.5,9.2,16.3,107.8,373.5,399.3,381,26.7,15.4,18.8,39.7,21.6,21.1,6.6,19.1,18.8,257.9,419.3,234,16.9,
        19.1,19.5,28.6,23.5,21.5,17.6,19,10,279.3,406.3,291.2,19,16.1,24.6,30.1,18.9,19.2,5,12.3,34.6,367.8,423.5,229.5,17,12.6,
        14.7,48.4,24.9,23.2,18.6,17.1,33.9,310.1,365.1,177.1,64.1,74.1,82.5,75.7,70.7,78.2,25.6,78.3,96.5,138.1,137.2,93.6,65.9,71.6,
        79.4,67.8,64,75.4,16.1,74.2,90.7,134.3,132.1,82,56.7,61,63.7,63.2,57.7,68.5,16.1,64,80.9,115.7,115.8,91.3,56,60.3,65.6,53.5,
        59.5,61.4,17.3,64.1,82.8,112.1,108.9,79.6,60.1,56.8,62.2,59.1,54.4,59.1,17.2,56.6,70.7,111.2,107.1,74.2,53.8,53.1,55.3,50.1,
        47.3,53.1,19.5,47.8,72.6,99.6,95.5,64.2,48.6,50.3,57.6,46.1,43.2,52.8,13.9,48.2,71.1,91.9,89.3,73,37.1,42.9,51.1,39.8,37,
        49.1,17.3,45.2,52.5,72.6,73.5,61.3)
sugar<-ts(data, freq=12, start=c(1974,1))

q<-rjd3sts::seasonalbreaks(sugar)
  

plot(q)

model<-rjd3sts::model()
llt<-rjd3sts::locallineartrend('l')
seas1<-rjd3sts::seasonal("s1", 12, "HarrisonStevens")
n1<-rjd3sts::noise('n1')
seas2<-rjd3sts::seasonal("s2", 12, "HarrisonStevens")
#n2<-rjd3sts::noise('n2')
rjd3sts::add(model, llt)
rjd3sts::add(model, seas1)
rjd3sts::add(model, n1)
rjd3sts::add(model, seas2)
#rjd3sts::add(model, n2)
eq1<-rjd3sts::equation("eq1")
eq2<-rjd3sts::equation("eq2")
rjd3sts::add_equation(eq1, 'l')
rjd3sts::add_equation(eq1, 's1')
rjd3sts::add_equation(eq1, 'n1')
rjd3sts::add_equation(eq2, 'l')
rjd3sts::add_equation(eq2, 's2')
rjd3sts::add_equation(eq2, 'n1')
rjd3sts::add(model, eq1)
rjd3sts::add(model, eq2)

i<-which.max(q)
m<-cbind(data, data)
m[i:length(data),1]<-NaN
m[1:(i-1),2]<-NaN
rslt<-rjd3sts::estimate(model, log(m))
ss<-rjd3sts::smoothed_states(rslt)
plot(log(data), type='l')
lines(ss[,1], col='red')
s1=ss[,3]
s2=ss[,15]
s1[i:length(data)]<-NaN
s2[1:(i-1)]<-NaN
seas<-cbind(s1, s2)
matplot(seas, col=c('red', 'blue'), type='l')
plot(ss[,3], type='l', col='blue')
lines(ss[,15], col='red')
